name: Post to OpenAI Thread

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Don't call the API, just print the payload"
        required: false
        default: "false"
  schedule:
    - cron: "0 * * * *"  # hourly

permissions:
  contents: write

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
      OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}
      SBX_FEED_URL: ${{ secrets.SBX_FEED_URL }}

    steps:
      - name: Sanity checks
        shell: bash
        run: |
          set -euo pipefail
          test -n "$OPENAI_API_KEY" || { echo "âŒ Missing OPENAI_API_KEY"; exit 1; }
          test -n "$OPENAI_THREAD_ID" || { echo "âŒ Missing OPENAI_THREAD_ID"; exit 1; }
          test -n "$OPENAI_ASSISTANT_ID" || { echo "âŒ Missing OPENAI_ASSISTANT_ID"; exit 1; }
          echo "âœ… Core secrets OK."
          if [ -n "${SBX_FEED_URL:-}" ]; then echo "âœ… SBX_FEED_URL set"; else echo "â„¹ï¸ No SBX_FEED_URL (feed step will skip)"; fi

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Compose base message
        id: compose
        shell: bash
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          LAST="$(tail -n 1 handover/SBX_HandoVER.md 2>/dev/null || true)"
          [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"
          printf 'SBX handover sync â€” %s\n%s\n' "$TS" "$LAST" > /tmp/body.txt
          echo "âœ… Base message ready"

      - name: Fetch SBX live feed (optional)
        if: env.SBX_FEED_URL != ''
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ“¡ Fetching SBX feed from $SBX_FEED_URL"
          HTTP=$(curl -sS -w '%{http_code}' -o /tmp/feed.json "$SBX_FEED_URL" || true)
          echo "HTTP $HTTP"
          if [ "$HTTP" = "200" ]; then
            {
              echo ""
              echo "---"
              echo "SBX Feed Snapshot (first 5 rows):"
              jq -r '
                (if type=="object" and has("data") then .data else . end)
                | (if type=="array" then . else [] end)
                | .[0:5]
                | map(
                    (.symbol // .ticker // "-")
                    + "\t" + (.grade // "-")
                    + "\t" + (.bias // "-")
                    + "\t" + (.setup // "-")
                    + "\t" + (.session // "-")
                  )
                | join("\n")
              ' /tmp/feed.json 2>/dev/null || head -n 40 /tmp/feed.json
            } >> /tmp/body.txt

            mkdir -p handover
            cp /tmp/feed.json handover/SBX_Feed_Snapshot.json
            git add handover/SBX_Feed_Snapshot.json || true
            git commit -m "ci: SBX feed snapshot" || true
            echo "âœ… SBX feed summary appended."
          else
            echo "âš ï¸ Feed fetch failed ($HTTP)" >> /tmp/body.txt
          fi

      - name: Verify thread exists
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -w '\nHTTP:%{http_code}\n' \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}" \
            | tee /tmp/thread_check.txt
          grep -q 'HTTP:200' /tmp/thread_check.txt || { echo "âŒ Thread not found"; exit 1; }

      - name: Verify assistant exists
        shell: bash
        run: |
          set -euo pipefail
          # Trim any stray CR/LF to avoid invalid JSON later
          CLEAN_ASST="$(printf '%s' "$OPENAI_ASSISTANT_ID" | tr -d '\r\n')"
          HTTP=$(curl -sS -o /tmp/asst.json -w '%{http_code}' \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/assistants/${CLEAN_ASST}")
          echo "Assistant GET HTTP: $HTTP"
          [ "$HTTP" = "200" ] || { echo "âŒ Assistant not found"; exit 1; }

      - name: Dry run?
        if: ${{ github.event.inputs.dry_run == 'true' }}
        shell: bash
        run: |
          echo "Dry run enabled. Would post this payload:"
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}' | tee payload.json
          exit 0

      - name: Post message to OpenAI (Assistants v2)
        id: post
        shell: bash
        run: |
          set -euo pipefail
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}' > /tmp/payload.json
          HTTP=$(curl -sS -o /tmp/resp.json -w '%{http_code}' \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/messages" \
            --data @/tmp/payload.json)
          echo "HTTP: $HTTP"
          [ "$HTTP" = "200" ] || { cat /tmp/resp.json; exit 1; }
          echo "âœ… Message posted."

      - name: Create run (safe JSON via jq)
        id: run
        shell: bash
        run: |
          set -euo pipefail
          CLEAN_ASST="$(printf '%s' "$OPENAI_ASSISTANT_ID" | tr -d '\r\n')"
          jq -nc --arg asst "$CLEAN_ASST" '{assistant_id:$asst}' > /tmp/run_payload.json
          echo "Run payload:"; cat /tmp/run_payload.json

          HTTP=$(curl -sS -o /tmp/run.json -w '%{http_code}' \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -H "OpenAI-Beta: assistants=v2" \
            -d @/tmp/run_payload.json \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/runs")
          echo "HTTP: $HTTP"
          [ "$HTTP" = "200" ] || { cat /tmp/run.json; exit 1; }
          RUN_ID=$(jq -r '.id // empty' /tmp/run.json)
          [ -n "$RUN_ID" ] || { echo "âŒ No run id returned"; exit 1; }
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_OUTPUT"
          echo "âœ… Run started."

      - name: Wait for completion
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.run.outputs.RUN_ID }}"
          echo "Waiting for run $RUN_ID..."
          for i in $(seq 1 100); do
            STATUS=$(curl -sS \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "OpenAI-Beta: assistants=v2" \
              "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/runs/${RUN_ID}" \
              | jq -r '.status // empty')
            echo "Status: $STATUS"
            [ "$STATUS" = "completed" ] && break
            case "$STATUS" in
              failed|cancelled|expired) echo "âŒ Run $STATUS"; exit 1 ;;
            esac
            sleep 3
          done

      - name: Get assistant response
        id: response
        shell: bash
        run: |
          set -euo pipefail
          curl -sS \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/messages?order=desc&limit=5" > /tmp/messages.json
          echo "Messages snapshot:"
          jq '.' /tmp/messages.json | sed -n '1,120p'
          REPLY=$(jq -r '.data[] | select(.role=="assistant") | .content[0].text.value // empty' /tmp/messages.json | head -n 1)
          [ -n "$REPLY" ] || REPLY="(no assistant reply found)"
          echo "Assistant reply:"
          echo "$REPLY"

      - name: Summary
        shell: bash
        run: |
          echo "âœ… Complete"
