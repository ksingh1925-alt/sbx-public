name: Post to OpenAI Thread

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Don't call the API, just print the payload"
        required: false
        default: "false"
  schedule:
    - cron: "0 * * * *"  # hourly; remove if you only want manual runs

permissions:
  contents: write  # we commit/push handover updates

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
      OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}
    steps:
      - name: Sanity checks (secrets present)
        run: |
          set -euo pipefail
          test -n "${OPENAI_API_KEY:-}"        || { echo "âŒ Missing OPENAI_API_KEY"; exit 1; }
          test -n "${OPENAI_THREAD_ID:-}"      || { echo "âŒ Missing OPENAI_THREAD_ID"; exit 1; }
          test -n "${OPENAI_ASSISTANT_ID:-}"   || { echo "âŒ Missing OPENAI_ASSISTANT_ID"; exit 1; }
          echo "âœ… Secrets present."

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git & sync main
        run: |
          set -euo pipefail
          git config --local user.email "actions@github.com"
          git config --local user.name  "github-actions[bot]"
          # Ensure we're on main and up to date
          git fetch origin
          git checkout main || git checkout -b main
          git pull --rebase origin main || true

      - name: Prepare handover file and compose message
        id: compose
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p handover
          # Ensure the file exists and has at least one line
          if [ ! -f handover/SBX_HandoVER.md ]; then
            printf "# SBX Handover\n" > handover/SBX_HandoVER.md
          fi
          if [ ! -s handover/SBX_HandoVER.md ]; then
            echo "Handover log initiated." >> handover/SBX_HandoVER.md
          fi

          TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          LAST="$(tail -n 1 handover/SBX_HandoVER.md || true)"
          [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

          EXTRA=""
          if [ -f status.json ]; then
            RUN_URL=$(jq -r '.workflow_url // empty' status.json)
            HOST=$(jq -r '.runner_hostname // empty' status.json)
            [ -n "$RUN_URL" ] && EXTRA="${EXTRA}\nrun: ${RUN_URL}"
            [ -n "$HOST" ] && EXTRA="${EXTRA}\nhost: ${HOST}"
          fi
          if [ -f handover/status.json ]; then
            HANDOVER_SUMMARY=$(jq -r '.summary // empty' handover/status.json)
          else
            HANDOVER_SUMMARY=""
          fi

          TEXT="SBX handover sync â€” ${TS}\n${LAST}"
          [ -n "$HANDOVER_SUMMARY" ] && TEXT="${TEXT}\nsummary: ${HANDOVER_SUMMARY}"
          [ -n "$EXTRA" ] && TEXT="${TEXT}\n${EXTRA}"

          printf '%s' "$TEXT" > /tmp/body.txt
          echo "Preview:"
          cat /tmp/body.txt
          echo ""

      - name: Verify thread exists (GET)
        shell: bash
        run: |
          set -euo pipefail
          HTTP=$(
            curl -sS -o /tmp/thread.json -w '%{http_code}' \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "OpenAI-Beta: assistants=v2" \
              "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}" || true
          )
          echo "Thread GET HTTP: $HTTP"
          [ "$HTTP" = "200" ] || { echo "âŒ Thread not found or auth failed"; cat /tmp/thread.json || true; exit 1; }

      - name: Dry run?
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "Dry run enabled. Would post this payload:"
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}'
          exit 0

      - name: Post message to OpenAI (Assistants v2)
        id: post
        shell: bash
        run: |
          set -euo pipefail
          # Build payload with content array (required)
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}' > /tmp/msg_payload.json

          MAX_RETRIES=4
          SLEEP=1
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Message attempt $attemptâ€¦"
            HTTP=$(
              curl -sS -o /tmp/msg.json -w '%{http_code}' \
                "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "OpenAI-Beta: assistants=v2" \
                --data @/tmp/msg_payload.json || true
            )
            echo "HTTP: $HTTP"; cat /tmp/msg.json || true
            if [ "$HTTP" = "200" ]; then
              MSG_ID=$(jq -r '.id // empty' /tmp/msg.json || true)
              [ -n "$MSG_ID" ] && { echo "MSG_ID=$MSG_ID" >> "$GITHUB_OUTPUT"; break; }
            fi
            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              echo "Retrying in ${SLEEP}sâ€¦"; sleep "$SLEEP"; SLEEP=$((SLEEP*2))
            else
              echo "âŒ Failed to post message after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Create run (trigger assistant) â€” robust retry
        id: run
        shell: bash
        run: |
          set -euo pipefail

          # Verify assistant exists (helps catch bad asst_ id)
          AHTTP=$(
            curl -sS -o /tmp/asst.json -w '%{http_code}' \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "OpenAI-Beta: assistants=v2" \
              "https://api.openai.com/v1/assistants/$OPENAI_ASSISTANT_ID" || true
          )
          echo "Assistant GET HTTP: $AHTTP"
          [ "$AHTTP" = "200" ] || { echo "âŒ Assistant not found"; cat /tmp/asst.json || true; exit 1; }

          # Build payload safely with jq (prevents invalid JSON)
          jq -nc --arg assistant_id "$OPENAI_ASSISTANT_ID" \
            '{assistant_id:$assistant_id}' > /tmp/run_payload.json
          echo "Run payload:"; cat /tmp/run_payload.json

          MAX_RETRIES=5
          SLEEP=1
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Create-run attempt $attemptâ€¦"
            HTTP=$(
              curl -sS -o /tmp/run.json -w '%{http_code}' \
                "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "OpenAI-Beta: assistants=v2" \
                --data @/tmp/run_payload.json || true
            )
            echo "HTTP: $HTTP"; cat /tmp/run.json || true
            if [ "$HTTP" = "200" ]; then
              RUN_ID=$(jq -r '.id // empty' /tmp/run.json)
              [ -n "$RUN_ID" ] && { echo "RUN_ID=$RUN_ID" >> "$GITHUB_OUTPUT"; break; }
            fi
            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              echo "Retrying in ${SLEEP}sâ€¦"; sleep "$SLEEP"; SLEEP=$((SLEEP*2))
            else
              echo "âŒ Failed to create run after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Wait for run completion
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.run.outputs.RUN_ID }}"
          MAX_WAIT=300
          ELAPSED=0
          echo "Waiting for run $RUN_IDâ€¦"
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            curl -sS \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "OpenAI-Beta: assistants=v2" \
              "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs/$RUN_ID" > /tmp/run_status.json
            STATUS=$(jq -r '.status // empty' /tmp/run_status.json)
            echo "status: $STATUS"
            case "$STATUS" in
              completed) echo "âœ… Completed"; break ;;
              failed|cancelled|expired) echo "âŒ $STATUS"; cat /tmp/run_status.json; exit 1 ;;
            esac
            sleep 3
            ELAPSED=$((ELAPSED+3))
          done
          [ $ELAPSED -lt $MAX_WAIT ] || { echo "âŒ Timed out waiting for run"; exit 1; }

      - name: Fetch assistant response
        id: response
        shell: bash
        run: |
          set -euo pipefail
          curl -sS \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages?order=desc&limit=10" > /tmp/messages.json
          echo "Messages snapshot:"; jq '.' /tmp/messages.json | sed -n '1,140p' || true

          # Pick the most recent assistant message
          REPLY=$(
            jq -r '.data[] | select(.role=="assistant") | .content[0].text.value // empty' /tmp/messages.json \
            | head -n 1
          )
          [ -n "$REPLY" ] || REPLY="(no assistant reply found)"

          printf '%s\n' "$REPLY" > /tmp/assistant_reply.txt

          {
            echo "RESPONSE<<EOF"
            echo "$REPLY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Append assistant reply to handover & push
        shell: bash
        run: |
          set -euo pipefail

          # Guard: ensure reply file exists
          [ -f /tmp/assistant_reply.txt ] || echo "(no assistant reply found)" > /tmp/assistant_reply.txt

          TS_NOW="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          {
            echo "Assistant reply @ ${TS_NOW}:"
            sed -n '1,30p' /tmp/assistant_reply.txt
            echo ""
          } >> handover/SBX_HandoVER.md

          echo "ðŸ”Ž Last 15 lines of handover/SBX_HandoVER.md:"
          tail -n 15 handover/SBX_HandoVER.md || true

          # Commit & push with rebase-safety
          git add handover/SBX_HandoVER.md
          git commit -m "ci: update SBX handover (append assistant reply)" || true
          git pull --rebase origin main || true
          git push origin main

      - name: Summary
        run: |
          echo "âœ… Complete"
          echo "Message ID: ${{ steps.post.outputs.MSG_ID }}"
          echo "Run ID:     ${{ steps.run.outputs.RUN_ID }}"
          echo
          echo "Response:"
          echo "${{ steps.response.outputs.RESPONSE }}"
