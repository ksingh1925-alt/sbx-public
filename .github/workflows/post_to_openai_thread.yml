name: Post to OpenAI Thread

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Don't call the API, just print the payload"
        required: false
        default: "false"
  schedule:
    - cron: "0 * * * *"   # hourly; remove if you only want manual runs

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
    steps:
      - name: Sanity checks
        run: |
          test -n "$OPENAI_API_KEY" || { echo "❌ Missing OPENAI_API_KEY"; exit 1; }
          test -n "$OPENAI_THREAD_ID" || { echo "❌ Missing OPENAI_THREAD_ID"; exit 1; }
          echo "✅ Secrets present."

      - name: Check out repo for handover file
        uses: actions/checkout@v4

      - name: Set Git author (repo-only)
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name  "github-actions[bot]"

      - name: Verify author (dry-run)
        run: |
          echo "sanity" > .git-author-check
          git add .git-author-check
          git commit -m "author check (dry-run)" --dry-run
          rm -f .git-author-check

      - name: Compose message from handover + both status.json files
        id: msg
        shell: bash
        run: |
          set -euo pipefail

          TS="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # Last line from handover file
          LAST="$(tail -n 1 handover/SBX_Handover.md 2>/dev/null || true)"
          [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

          # Merge fields from root status.json
          EXTRA=""
          if [ -f status.json ]; then
            RUN_URL=$(jq -r '.workflow_url // .run_url // empty' status.json)
            HOST=$(jq -r '.runner_hostname // .host // empty' status.json)
            [ -n "$RUN_URL" ] && EXTRA+="\nrun: ${RUN_URL}"
            [ -n "$HOST" ] && EXTRA+="\nhost: ${HOST}"
          fi

          # Optional short summary from handover/status.json (if present)
          HANDOVER_SUMMARY=""
          if [ -f handover/status.json ]; then
            HANDOVER_SUMMARY=$(jq -r '.summary // .short // empty' handover/status.json)
          fi

          TEXT="SBX handover sync — ${TS}\n${LAST}"
          [ -n "$HANDOVER_SUMMARY" ] && TEXT="${TEXT}\nsummary: ${HANDOVER_SUMMARY}"
          [ -n "$EXTRA" ] && TEXT="${TEXT}${EXTRA}"

          printf '%s' "$TEXT" > /tmp/body.txt

          echo "text<<EOF" >> "$GITHUB_OUTPUT"
          cat /tmp/body.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "Preview:"
          cat /tmp/body.txt

      - name: Dry run?
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "Dry run enabled. Would post this payload:"
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}'
          exit 0

      - name: Post message to OpenAI (Assistants v2)
        id: post
        run: |
          set -euo pipefail
          # Build JSON safely with jq
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}' > /tmp/payload.json

          MAX_RETRIES=4
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt: calling OpenAI"
            HTTP_CODE=$(
              curl -sS -o /tmp/resp.json -w '%{http_code}' \
                https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/messages \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer ${OPENAI_API_KEY}" \
                -H "OpenAI-Beta: assistants=v2" \
                --data @/tmp/payload.json
            ) || true

            echo "Received HTTP code: $HTTP_CODE"
            # Quick validation
            if [ "$HTTP_CODE" = "200" ]; then
              MSG_ID=$(jq -r '.id // empty' /tmp/resp.json)
              if [ -n "$MSG_ID" ] && [[ "$MSG_ID" == msg_* ]]; then
                echo "✅ Posted message id: $MSG_ID"
                echo "HTTP_CODE=$HTTP_CODE" >> $GITHUB_OUTPUT
                echo "MSG_ID=$MSG_ID" >> $GITHUB_OUTPUT
                break
              else
                echo "Warning: response missing/invalid id; will retry if attempts remain"
              fi
            else
              echo "Warning: HTTP $HTTP_CODE; will retry if attempts remain"
            fi

            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              SLEEP=$((2 ** attempt))
              echo "Sleeping $SLEEP seconds before retrying..."
              sleep $SLEEP
            else
              echo "❌ All $MAX_RETRIES attempts failed. Response body:" >&2
              cat /tmp/resp.json >&2 || true
              exit 1
            fi
          done

      - name: Summary
        run: |
          echo "OpenAI post complete."
          echo "HTTP code: ${{ steps.post.outputs.HTTP_CODE }}"
          echo "Message id: ${{ steps.post.outputs.MSG_ID }}"
