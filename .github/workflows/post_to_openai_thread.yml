name: Post to OpenAI Thread (with SBX Feed Preview)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Don't call OpenAI; just echo payload"
        required: false
        default: "false"
  schedule:
    - cron: "0 * * * *"  # hourly; delete if you only want manual runs

permissions:
  contents: read  # not pushing, artifact only

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
      OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}
    steps:
      - name: Sanity checks (secrets present)
        run: |
          test -n "$OPENAI_API_KEY" || { echo "❌ Missing OPENAI_API_KEY"; exit 1; }
          test -n "$OPENAI_THREAD_ID" || { echo "❌ Missing OPENAI_THREAD_ID"; exit 1; }
          test -n "$OPENAI_ASSISTANT_ID" || { echo "❌ Missing OPENAI_ASSISTANT_ID"; exit 1; }
          echo "✅ Secrets present."

      - name: Checkout repo (to read handover files if present)
        uses: actions/checkout@v4

      - name: Compose message (handover last line)
        id: compose
        shell: bash
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          # Read last line of handover file if it exists
          LAST="$(tail -n 1 handover/SBX_HandoVER.md 2>/dev/null || true)"
          [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

          printf 'SBX handover sync — %s\n%s\n' "$TS" "$LAST" > /tmp/body.txt

          echo "Preview so far:"
          cat /tmp/body.txt

      - name: Fetch SBX feed and append preview (optional)
        if: ${{ always() }}
        env:
          SBX_FEED_URL: ${{ secrets.SBX_FEED_URL }}
          SBX_FEED_TOKEN: ${{ secrets.SBX_FEED_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${SBX_FEED_URL:-}" ]; then
            echo "ℹ️ SBX_FEED_URL not set; skipping feed fetch."
            exit 0
          fi

          HDRS=()
          if [ -n "${SBX_FEED_TOKEN:-}" ]; then
            HDRS+=( -H "Authorization: Bearer ${SBX_FEED_TOKEN}" )
          fi

          mkdir -p handover

          echo "→ Fetching SBX feed …"
          if ! curl -sS "${SBX_FEED_URL}" "${HDRS[@]}" -o /tmp/sbx_feed_raw.json; then
            echo "⚠️ SBX feed fetch failed; skipping preview." >> /tmp/body.txt
            exit 0
          fi

          # Normalize / pretty-snapshot
          if jq -e . >/dev/null 2>&1 < /tmp/sbx_feed_raw.json; then
            jq '.[0:200]' /tmp/sbx_feed_raw.json > handover/SBX_Feed_Snapshot.json 2>/dev/null \
              || jq '.' /tmp/sbx_feed_raw.json > handover/SBX_Feed_Snapshot.json
          else
            cp /tmp/sbx_feed_raw.json handover/SBX_Feed_Snapshot.json
          fi

          echo "" >> /tmp/body.txt
          echo "SBX feed — top 5 rows (compact):" >> /tmp/body.txt
          if jq -e . >/dev/null 2>&1 < /tmp/sbx_feed_raw.json; then
            PREVIEW=$(jq -r '
              .[0:5]
              | map(
                  if type=="object" then
                    {
                      t:(.timestamp//.time//.t//""),
                      sym:(.symbol//.sym//""),
                      bias:(.bias//""),
                      grade:(.grade//"")
                    }
                  else .
                  end
                )
              | .[]
              | ((if .t=="" then "" else "[\(.t)] " end)
                 + (if .sym=="" then "" else "\(.sym) " end)
                 + (if .bias=="" then "" else "bias=\(.bias) " end)
                 + (if .grade=="" then "" else "grade=\(.grade)" end))
            ' /tmp/sbx_feed_raw.json)
            if [ -n "$PREVIEW" ]; then
              echo "$PREVIEW" >> /tmp/body.txt
            else
              jq -c '.[0:5]' /tmp/sbx_feed_raw.json >> /tmp/body.txt || echo "(no preview)" >> /tmp/body.txt
            fi
          else
            echo "(Feed was not valid JSON; raw saved to snapshot.)" >> /tmp/body.txt
          fi

      - name: Upload SBX feed snapshot (artifact)
        if: ${{ hashFiles('handover/SBX_Feed_Snapshot.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: sbx_feed_snapshot
          path: handover/SBX_Feed_Snapshot.json
          if-no-files-found: ignore

      - name: Verify thread exists (GET)
        shell: bash
        run: |
          set -euo pipefail
          echo "GET https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}"
          curl -sS -w '\nHTTP:%{http_code}\n' \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}" \
            | tee /tmp/thread_check.txt
          grep -q 'HTTP:200' /tmp/thread_check.txt || { echo "❌ Thread not found or auth failed"; exit 1; }

      - name: Dry run?
        if: ${{ github.event.inputs.dry_run == 'true' }}
        shell: bash
        run: |
          echo "Dry-run enabled. Would post this payload:"
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}' | tee /tmp/payload.json
          exit 0

      - name: Post message to OpenAI (Assistants v2)
        id: post
        shell: bash
        run: |
          set -euo pipefail
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}' > /tmp/payload.json

          MAX_RETRIES=4
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt: posting message…"
            HTTP_CODE=$(
              curl -sS -o /tmp/resp_msg.json -w '%{http_code}' \
                "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/messages" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer ${OPENAI_API_KEY}" \
                -H "OpenAI-Beta: assistants=v2" \
                --data @/tmp/payload.json || true
            )
            echo "HTTP=$HTTP_CODE"; cat /tmp/resp_msg.json || true

            if [ "$HTTP_CODE" = "200" ]; then
              MSG_ID=$(jq -r '.id // empty' /tmp/resp_msg.json || true)
              if [ -n "$MSG_ID" ]; then
                echo "✅ Posted message: $MSG_ID"
                echo "MSG_ID=$MSG_ID" >> "$GITHUB_OUTPUT"
                break
              fi
            fi

            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              SLEEP=$((2 ** attempt))
              echo "Retrying in ${SLEEP}s…"; sleep "$SLEEP"
            else
              echo "❌ Failed after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Create run (trigger assistant)
        id: run
        shell: bash
        run: |
          set -euo pipefail
          jq -n --arg a "$OPENAI_ASSISTANT_ID" '{assistant_id:$a}' > /tmp/run.json

          HTTP_CODE=$(
            curl -sS -o /tmp/resp_run.json -w '%{http_code}' \
              "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/runs" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${OPENAI_API_KEY}" \
              -H "OpenAI-Beta: assistants=v2" \
              --data @/tmp/run.json
          )
          echo "HTTP=$HTTP_CODE"; cat /tmp/resp_run.json || true
          [ "$HTTP_CODE" = "200" ] || { echo "❌ Failed to create run"; exit 1; }

          RUN_ID=$(jq -r '.id // empty' /tmp/resp_run.json)
          [ -n "$RUN_ID" ] || { echo "❌ Run id missing"; exit 1; }
          echo "✅ Run: $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Wait for run completion
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.run.outputs.RUN_ID }}"
          MAX_WAIT=300
          ELAPSED=0

          echo "Waiting for run $RUN_ID…"
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            curl -sS \
              -H "Authorization: Bearer ${OPENAI_API_KEY}" \
              -H "OpenAI-Beta: assistants=v2" \
              "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/runs/${RUN_ID}" > /tmp/run_status.json

            STATUS=$(jq -r '.status // empty' /tmp/run_status.json)
            echo "status: $STATUS"

            case "$STATUS" in
              completed) echo "✅ Completed"; break ;;
              failed|cancelled|expired)
                echo "❌ $STATUS"; cat /tmp/run_status.json; exit 1 ;;
            esac

            sleep 3
            ELAPSED=$((ELAPSED+3))
          done
          [ $ELAPSED -lt $MAX_WAIT ] || { echo "❌ Timed out"; exit 1; }

      - name: Get assistant response
        id: response
        shell: bash
        run: |
          set -euo pipefail
          curl -sS \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}/messages?order=desc&limit=10" > /tmp/messages.json

          echo "Messages snapshot:"
          jq '.' /tmp/messages.json | sed -n '1,150p'

          REPLY=$(jq -r '.data[] | select(.role=="assistant") | .content[0].text.value // empty' /tmp/messages.json | head -n 1)
          [ -n "$REPLY" ] || REPLY="(no response)"

          echo "Assistant says:"
          echo "$REPLY"

      - name: Upload composed message (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: posted_body
          path: /tmp/body.txt
          if-no-files-found: warn

      - name: Summary
        run: |
          echo "✅ Complete"
          echo "Message ID: ${{ steps.post.outputs.MSG_ID }}"
          echo "Run ID:     ${{ steps.run.outputs.RUN_ID }}"
