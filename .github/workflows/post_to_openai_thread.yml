name: Post to OpenAI Thread

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Don't call the API, just print the payload"
        required: false
        default: "false"
  schedule:
    - cron: "0 * * * *"  # hourly; remove if you only want manual runs

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
      OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}

    steps:
      - name: Sanity checks
        run: |
          test -n "$OPENAI_API_KEY"    || { echo "❌ Missing OPENAI_API_KEY"; exit 1; }
          test -n "$OPENAI_THREAD_ID"  || { echo "❌ Missing OPENAI_THREAD_ID"; exit 1; }
          test -n "$OPENAI_ASSISTANT_ID" || { echo "❌ Missing OPENAI_ASSISTANT_ID"; exit 1; }
          echo "✅ Secrets present."

      - name: Check out repo for handover file
        name: Post to OpenAI Thread

        on:
          workflow_dispatch:
            inputs:
              dry_run:
                description: "Don't call the API, just print the payload"
                required: false
                default: "false"
          schedule:
            - cron: "0 * * * *"  # hourly; remove if you only want manual runs

        permissions:
          contents: read

        jobs:
          post:
            runs-on: ubuntu-latest
            env:
              OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
              OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
              OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}

            steps:
              - name: Sanity checks (secrets present?)
                run: |
                  test -n "$OPENAI_API_KEY"       || { echo "❌ Missing OPENAI_API_KEY"; exit 1; }
                  test -n "$OPENAI_THREAD_ID"     || { echo "❌ Missing OPENAI_THREAD_ID"; exit 1; }
                  test -n "$OPENAI_ASSISTANT_ID"  || { echo "❌ Missing OPENAI_ASSISTANT_ID"; exit 1; }
                  echo "✅ Secrets present."

              - name: Check out repo (for handover files)
                uses: actions/checkout@v4

              - name: Set Git author (repo-only)
                run: |
                  git config --local user.email "actions@github.com"
                  git config --local user.name  "github-actions[bot]"

              - name: Compose message from handover + status.json files
                id: compose
                shell: bash
                run: |
                  set -euo pipefail

                  TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                  LAST="$(tail -n 1 handover/SBX_HandoVER.md 2>/dev/null || true)"
                  [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

                  EXTRA=""
                  if [ -f status.json ]; then
                    RUN_URL=$(jq -r '.workflow_url // empty' status.json)
                    HOST=$(jq -r '.runner_hostname // empty' status.json)
                    [ -n "$RUN_URL" ] && EXTRA="${EXTRA}\nrun: ${RUN_URL}"
                    [ -n "$HOST" ] && EXTRA="${EXTRA}\nhost: ${HOST}"
                  fi

                  HANDOVER_SUMMARY=""
                  if [ -f handover/status.json ]; then
                    HANDOVER_SUMMARY=$(jq -r '.summary // empty' handover/status.json)
                  fi

                  TEXT="SBX handover sync - ${TS}\n${LAST}"
                  [ -n "$HANDOVER_SUMMARY" ] && TEXT="${TEXT}\nsummary: ${HANDOVER_SUMMARY}"
                  [ -n "$EXTRA" ] && TEXT="${TEXT}\n${EXTRA}"

                  printf '%s' "$TEXT" > /tmp/body.txt

                  echo "Preview:"
                  cat /tmp/body.txt
                  echo ""

              - name: Verify thread exists (GET)
                shell: bash
                run: |
                  set -euo pipefail
                  echo "GET https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}"
                  curl -sS -w '\nHTTP:%{http_code}\n' \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    -H "OpenAI-Beta: assistants=v2" \
                    "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}" \
                    | tee /tmp/thread_check.txt
                  grep -q '^HTTP:200$' /tmp/thread_check.txt || { echo "❌ Thread not found or auth failed"; exit 1; }

              - name: Dry run?
                if: ${{ github.event.inputs.dry_run == 'true' }}
                run: |
                  echo "Dry run enabled. Would post this payload:"
                  jq -nc --rawfile t /tmp/body.txt '{role:"user", content:{type:"text", text:$t}}'
                  exit 0

              - name: Post message to OpenAI (Assistants v2)
                id: post
                shell: bash
                run: |
                  set -euo pipefail
                  jq -nc --rawfile t /tmp/body.txt '{role:"user", content:{type:"text", text:$t}}' > /tmp/payload.json

                  MAX_RETRIES=4
                  for attempt in $(seq 1 $MAX_RETRIES); do
                    echo "Attempt $attempt: posting message…"
                    HTTP_CODE=$(
                      curl -sS -o /tmp/resp.json -w '%{http_code}' \
                        "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages" \
                        -H "Content-Type: application/json" \
                        -H "Authorization: Bearer $OPENAI_API_KEY" \
                        -H "OpenAI-Beta: assistants=v2" \
                        --data @/tmp/payload.json || true
                    )

                    echo "HTTP: $HTTP_CODE"
                    echo "Resp body:"; cat /tmp/resp.json || true

                    if [ "$HTTP_CODE" = "200" ]; then
                      MSG_ID=$(jq -r '.id // empty' /tmp/resp.json || true)
                      if [ -n "$MSG_ID" ]; then
                        echo "✅ Posted message id: $MSG_ID"
                        echo "MSG_ID=$MSG_ID" >> "$GITHUB_OUTPUT"
                        break
                      fi
                    fi

                    if [ "$attempt" -lt "$MAX_RETRIES" ]; then
                      SLEEP=$((2 ** attempt))
                      echo "Retrying in $SLEEP s…"
                      sleep "$SLEEP"
                    else
                      echo "❌ Failed after $MAX_RETRIES attempts."
                      exit 1
                    fi
                  done

              - name: Create run to get assistant response
                id: run
                shell: bash
                run: |
                  set -euo pipefail
                  echo "Creating run with assistant…"
                  HTTP_CODE=$(
                    curl -sS -o /tmp/run.json -w '%{http_code}' \
                      "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs" \
                      -H "Content-Type: application/json" \
                      -H "Authorization: Bearer $OPENAI_API_KEY" \
                      -H "OpenAI-Beta: assistants=v2" \
                      -d "{\"assistant_id\":\"$OPENAI_ASSISTANT_ID\"}"
                  )

                  echo "HTTP: $HTTP_CODE"
                  echo "Run resp:"; cat /tmp/run.json || true
                  [ "$HTTP_CODE" = "200" ] || { echo "❌ Failed to create run"; exit 1; }

                  RUN_ID=$(jq -r '.id // empty' /tmp/run.json)
                  [ -n "$RUN_ID" ] || { echo "❌ No run ID in response"; exit 1; }
                  echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT

              - name: Wait for run completion
                shell: bash
                run: |
                  set -euo pipefail
                  RUN_ID="${{ steps.run.outputs.RUN_ID }}"
                  MAX_WAIT=300
                  ELAPSED=0

                  echo "Waiting for run $RUN_ID…"
                  while [ $ELAPSED -lt $MAX_WAIT ]; do
                    curl -sS \
                      -H "Authorization: Bearer $OPENAI_API_KEY" \
                      -H "OpenAI-Beta: assistants=v2" \
                      "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs/$RUN_ID" > /tmp/run_status.json

                    STATUS=$(jq -r '.status // empty' /tmp/run_status.json)
                    echo "status: $STATUS"

                    case "$STATUS" in
                      completed) echo "✅ Completed"; break ;;
                      failed|cancelled|expired) echo "❌ $STATUS"; cat /tmp/run_status.json; exit 1 ;;
                    esac

                    sleep 3
                    ELAPSED=$((ELAPSED+3))
                  done

                  [ $ELAPSED -lt $MAX_WAIT ] || { echo "❌ Timed out"; exit 1; }

              - name: Get assistant response
                id: response
                shell: bash
                run: |
                  set -euo pipefail
                  curl -sS \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    -H "OpenAI-Beta: assistants=v2" \
                    "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages?order=desc&limit=10" > /tmp/messages.json

                  echo "Messages snapshot:"
                  jq '.' /tmp/messages.json | sed -n '1,120p'

                  REPLY=$(
                    jq -r '.data[] | select(.role=="assistant") | .content[0].text.value // empty' /tmp/messages.json \
                    | head -n 1
                  )
                  [ -n "$REPLY" ] || REPLY="(no assistant reply found)"

                  {
                    echo "RESPONSE<<EOF"
                    echo "$REPLY"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

                  echo "Assistant says:"
                  echo "$REPLY"

              - name: Summary
                run: |
                  echo "OpenAI post complete."
                  echo "Message id:  ${{ steps.post.outputs.MSG_ID }}"
                  echo "Run id:      ${{ steps.run.outputs.RUN_ID }}"
                  echo
                  echo "Assistant response:"
                  echo "${{ steps.response.outputs.RESPONSE }}"

      - name: Verify author (dry-run only)
        run: |
          echo "sanity" > .git-author-check
          git add .git-author-check
          git commit -m "author check (dry-run)" --dry-run
          rm -f .git-author-check

      - name: Compose message from handover + status.json files
        id: compose
        shell: bash
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          LAST="$(tail -n 1 handover/SBX_HandoVER.md 2>/dev/null || true)"
          [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

          EXTRA=""
          if [ -f status.json ]; then
            RUN_URL=$(jq -r '.workflow_url // empty' status.json)
            HOST=$(jq -r '.runner_hostname // empty' status.json)
            [ -n "$RUN_URL" ] && EXTRA="${EXTRA}\nrun: ${RUN_URL}"
            [ -n "$HOST" ] && EXTRA="${EXTRA}\nhost: ${HOST}"
          fi

          HANDOVER_SUMMARY=""
          if [ -f handover/status.json ]; then
            HANDOVER_SUMMARY=$(jq -r '.summary // empty' handover/status.json)
          fi

          TEXT="SBX handover sync — ${TS}\n${LAST}"
          [ -n "$HANDOVER_SUMMARY" ] && TEXT="${TEXT}\nsummary: ${HANDOVER_SUMMARY}"
          [ -n "$EXTRA" ] && TEXT="${TEXT}\n${EXTRA}"

          printf '%s' "$TEXT" > /tmp/body.txt

          echo "Preview:"
          cat /tmp/body.txt
          echo ""

          # also write to $GITHUB_OUTPUT for debugging if desired
          {
            echo "PREVIEW<<EOF"
            cat /tmp/body.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Verify thread exists (GET)
        shell: bash
        run: |
          set -euo pipefail
          echo "GET https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}"
          curl -sS -w '\nHTTP:%{http_code}\n' \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}" \
            | tee /tmp/thread_check.txt
          grep -q 'HTTP:200' /tmp/thread_check.txt || { echo "❌ Thread not found or auth failed"; exit 1; }

      - name: Dry run?
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "Dry run enabled. Would post this payload:"
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:{type:"text", text:$t}}'
          exit 0

      - name: Post message to OpenAI (Assistants v2)
        id: post
        shell: bash
        run: |
          set -euo pipefail
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:{type:"text", text:$t}}' > /tmp/payload.json

          MAX_RETRIES=4
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt: posting message…"
            HTTP_CODE=$(
              curl -sS -o /tmp/resp.json -w '%{http_code}' \
                https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "OpenAI-Beta: assistants=v2" \
                --data @/tmp/payload.json || true
            )
            echo "HTTP=$HTTP_CODE"
            echo "Resp:"; cat /tmp/resp.json || true

            if [ "$HTTP_CODE" = "200" ]; then
              MSG_ID=$(jq -r '.id // empty' /tmp/resp.json || true)
              if [ -n "$MSG_ID" ]; then
                echo "✅ Posted message id: $MSG_ID"
                echo "HTTP_CODE=$HTTP_CODE" >> "$GITHUB_OUTPUT"
                echo "MSG_ID=$MSG_ID"       >> "$GITHUB_OUTPUT"
                break
              fi
            fi

            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              SLEEP=$((2 ** attempt))
              echo "Retrying in $SLEEP s…"
              sleep "$SLEEP"
            else
              echo "❌ Failed to post after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Create run (trigger assistant)
        id: run
        shell: bash
        run: |
          set -euo pipefail
          HTTP_CODE=$(
            curl -sS -o /tmp/run.json -w '%{http_code}' \
              https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "OpenAI-Beta: assistants=v2" \
              -d "{\"assistant_id\":\"$OPENAI_ASSISTANT_ID\"}"
          )
          echo "HTTP=$HTTP_CODE"
          echo "Run resp:"; cat /tmp/run.json || true
          [ "$HTTP_CODE" = "200" ] || { echo "❌ Failed to create run"; exit 1; }

          RUN_ID=$(jq -r '.id // empty' /tmp/run.json)
          [ -n "$RUN_ID" ] || { echo "❌ Run id missing"; exit 1; }
          echo "✅ Run id: $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Wait for run completion
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.run.outputs.RUN_ID }}"
          MAX_WAIT=300
          ELAPSED=0
          echo "Waiting for run $RUN_ID…"
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            curl -sS \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "OpenAI-Beta: assistants=v2" \
              "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs/$RUN_ID" > /tmp/run_status.json
            STATUS=$(jq -r '.status // empty' /tmp/run_status.json)
            echo "status: $STATUS"
            case "$STATUS" in
              completed) echo "✅ Completed"; break ;;
              failed|cancelled|expired) echo "❌ $STATUS"; cat /tmp/run_status.json; exit 1 ;;
            esac
            sleep 3
            ELAPSED=$((ELAPSED+3))
          done
          [ $ELAPSED -lt $MAX_WAIT ] || { echo "❌ Timed out"; exit 1; }

      - name: Fetch assistant response
        id: response
        shell: bash
        run: |
          set -euo pipefail
          curl -sS \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Beta: assistants=v2" \
            "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages?order=desc&limit=10" > /tmp/messages.json

          echo "Messages snapshot:"
          jq '.' /tmp/messages.json | sed -n '1,120p'

          REPLY=$(
            jq -r '.data[] | select(.role=="assistant") | .content[0].text.value // empty' /tmp/messages.json \
            | head -n 1
          )
          [ -n "$REPLY" ] || REPLY="(no assistant reply found)"
          echo "Assistant says:"
          echo "$REPLY"

          {
            echo "RESPONSE<<EOF"
            echo "$REPLY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "OpenAI post complete."
          echo "Message id:  ${{ steps.post.outputs.MSG_ID }}"
          echo "Run id:       ${{ steps.run.outputs.RUN_ID }}"
          echo
          echo "Assistant response:"
          echo "${{ steps.response.outputs.RESPONSE }}"
name: Post to OpenAI Thread

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Don't call the API, just print the payload"
        required: false
        default: "false"
  schedule:
    - cron: "0 * * * *"   # hourly; remove if you only want manual runs

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
    steps:
      - name: Sanity checks
        run: |
          test -n "$OPENAI_API_KEY" || { echo "❌ Missing OPENAI_API_KEY"; exit 1; }
          test -n "$OPENAI_THREAD_ID" || { echo "❌ Missing OPENAI_THREAD_ID"; exit 1; }
          echo "✅ Secrets present."

      - name: Check out repo for handover file
        uses: actions/checkout@v4

      - name: Set Git author (repo-only)
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name  "github-actions[bot]"

      - name: Verify author (dry-run)
        run: |
          echo "sanity" > .git-author-check
          git add .git-author-check
          git commit -m "author check (dry-run)" --dry-run
          rm -f .git-author-check

      - name: Compose message from handover + both status.json files
        id: msg
        shell: bash
        run: |
          set -euo pipefail

          TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          LAST="$(tail -n 1 handover/SBX_HandoVER.md 2>/dev/null || true)"
          [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

          EXTRA=""
          if [ -f status.json ]; then
            RUN_URL=$(jq -r '.workflow_url // empty' status.json)
            HOST=$(jq -r '.runner_hostname // empty' status.json)
            [ -n "$RUN_URL" ] && EXTRA="${EXTRA}\nrun: ${RUN_URL}"
            [ -n "$HOST" ] && EXTRA="${EXTRA}\nhost: ${HOST}"
          fi

          HANDOVER_SUMMARY=""
          if [ -f handover/status.json ]; then
            HANDOVER_SUMMARY=$(jq -r '.summary // empty' handover/status.json)
          fi

          TEXT="SBX handover sync — ${TS}\n${LAST}"
          [ -n "$HANDOVER_SUMMARY" ] && TEXT="${TEXT}\nsummary: ${HANDOVER_SUMMARY}"
          [ -n "$EXTRA" ] && TEXT="${TEXT}\n${EXTRA}"

          printf '%s' "$TEXT" > /tmp/body.txt
          echo "Preview:"
          cat /tmp/body.txt

          # Write multi-line output to $GITHUB_OUTPUT using a unique delimiter
          DELIM="GHX_$RANDOM_$(date +%s)"
          {
            echo "text<<$DELIM"
            cat /tmp/body.txt
            echo "$DELIM"
          } >> "$GITHUB_OUTPUT"

      - name: Verify thread exists (GET)
        run: |
          set -euo pipefail
          echo "GET https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}"
          curl -sS -w '\nHTTP:%{http_code}\n' \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "OpenAI-Beta: assistants=v2" \
            https://api.openai.com/v1/threads/${OPENAI_THREAD_ID} \
            | tee /tmp/thread_check.txt
          grep -q '^HTTP:200$' /tmp/thread_check.txt || (echo "❌ Thread not found or auth failed"; exit 1)

      - name: Dry run?
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "Dry run enabled. Would post this payload:"
          jq -nc --rawfile t /tmp/body.txt '{role:"user", content:[{type:"text", text:$t}]}'
          exit 0

      - name: Post message to OpenAI (Assistants v2)
        name: Post to OpenAI Thread

        on:
          workflow_dispatch:
            inputs:
              dry_run:
                description: "Don't call the API, just print the payload"
                required: false
                default: "false"
          schedule:
            - cron: "0 * * * *"  # hourly; remove if you only want manual runs

        jobs:
          post:
            runs-on: ubuntu-latest
            env:
              OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
              OPENAI_THREAD_ID: ${{ secrets.OPENAI_THREAD_ID }}
              OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}

            steps:
              - name: Sanity checks
                run: |
                  test -n "$OPENAI_API_KEY" || { echo "❌ Missing OPENAI_API_KEY"; exit 1; }
                  test -n "$OPENAI_THREAD_ID" || { echo "❌ Missing OPENAI_THREAD_ID"; exit 1; }
                  test -n "$OPENAI_ASSISTANT_ID" || { echo "❌ Missing OPENAI_ASSISTANT_ID"; exit 1; }
                  echo "✅ Secrets present."

              - name: Check out repo for handover file
                uses: actions/checkout@v4

              - name: Set Git author (repo-only)
                run: |
                  git config --local user.email "actions@github.com"
                  git config --local user.name "github-actions[bot]"

              - name: Verify author (dry-run)
                run: |
                  echo "sanity" > .git-author-check
                  git add .git-author-check
                  git commit -m "author check (dry-run)" --dry-run
                  rm -f .git-author-check

              - name: Compose message from handover + both status.json files
                id: msg
                shell: bash
                run: |
                  set -euo pipefail

                  TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                  LAST="$(tail -n 1 handover/SBX_HandoVER.md 2>/dev/null || true)"
                  [ -z "$LAST" ] && LAST="(no last line found in handover/SBX_HandoVER.md)"

                  EXTRA=""
                  if [ -f status.json ]; then
                    RUN_URL=$(jq -r '.workflow_url // empty' status.json)
                    HOST=$(jq -r '.runner_hostname // empty' status.json)
                    [ -n "$RUN_URL" ] && EXTRA="${EXTRA}\nrun: ${RUN_URL}"
                    [ -n "$HOST" ] && EXTRA="${EXTRA}\nhost: ${HOST}"
                  fi

                  HANDOVER_SUMMARY=""
                  if [ -f handover/status.json ]; then
                    HANDOVER_SUMMARY=$(jq -r '.summary // empty' handover/status.json)
                  fi

                  TEXT="SBX handover sync — ${TS}\n${LAST}"
                  [ -n "$HANDOVER_SUMMARY" ] && TEXT="${TEXT}\nsummary: ${HANDOVER_SUMMARY}"
                  [ -n "$EXTRA" ] && TEXT="${TEXT}\n${EXTRA}"

                  printf '%s' "$TEXT" > /tmp/body.txt
                  echo "Preview:"
                  cat /tmp/body.txt
                  echo ""

              - name: Verify thread exists (GET)
                run: |
                  set -euo pipefail
                  echo "GET https://api.openai.com/v1/threads/${OPENAI_THREAD_ID}"
                  curl -sS -w '\nHTTP:%{http_code}\n' \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    -H "OpenAI-Beta: assistants=v2" \
                    https://api.openai.com/v1/threads/${OPENAI_THREAD_ID} \
                    | tee /tmp/thread_check.txt
                  grep -q 'HTTP:200' /tmp/thread_check.txt || { echo "❌ Thread not found or auth failed"; exit 1; }

              - name: Dry run?
                if: ${{ github.event.inputs.dry_run == 'true' }}
                run: |
                  echo "Dry run enabled. Would post this payload:"
                  jq -nc --rawfile t /tmp/body.txt '{role:"user", content:{type:"text", text:$t}}'
                  exit 0

              - name: Post message to OpenAI (Assistants v2)
                id: post
                shell: bash
                run: |
                  set -euo pipefail
                  jq -nc --rawfile t /tmp/body.txt '{role:"user", content:{type:"text", text:$t}}' > /tmp/payload.json

                  MAX_RETRIES=4
                  for attempt in $(seq 1 $MAX_RETRIES); do
                    echo "Attempt $attempt: calling OpenAI..."
                    HTTP_CODE=$(
                      curl -sS -o /tmp/resp.json -w '%{http_code}' \
                        https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages \
                        -H "Content-Type: application/json" \
                        -H "Authorization: Bearer $OPENAI_API_KEY" \
                        -H "OpenAI-Beta: assistants=v2" \
                        --data @/tmp/payload.json || true
                    )

                    echo "Resp body:"; cat /tmp/resp.json || true
                    echo "HTTP code: $HTTP_CODE"

                    if [ "$HTTP_CODE" = "200" ]; then
                      MSG_ID=$(jq -r '.id // empty' /tmp/resp.json || true)
                      if [ -n "$MSG_ID" ]; then
                        echo "✅ Posted message id: $MSG_ID"
                        echo "MSG_ID=$MSG_ID" >> $GITHUB_OUTPUT
                        break
                      fi
                    fi

                    if [ "$attempt" -lt "$MAX_RETRIES" ]; then
                      SLEEP=$((2 ** attempt))
                      echo "Retrying in $SLEEP s…"
                      sleep "$SLEEP"
                    else
                      echo "❌ Failed after $MAX_RETRIES attempts. Response below:" >&2
                      cat /tmp/resp.json >&2 || true
                      exit 1
                    fi
                  done

              - name: Create run to get assistant response
                id: run
                shell: bash
                run: |
                  set -euo pipefail

                  echo "Creating run with assistant..."
                  HTTP_CODE=$(
                    curl -sS -o /tmp/run.json -w '%{http_code}' \
                      https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs \
                      -H "Content-Type: application/json" \
                      -H "Authorization: Bearer $OPENAI_API_KEY" \
                      -H "OpenAI-Beta: assistants=v2" \
                      -d "{\"assistant_id\": \"$OPENAI_ASSISTANT_ID\"}"
                  )

                  echo "Run response:"; cat /tmp/run.json || true
                  echo "HTTP code: $HTTP_CODE"
                  [ "$HTTP_CODE" = "200" ] || { echo "❌ Failed to create run"; exit 1; }

                  RUN_ID=$(jq -r '.id // empty' /tmp/run.json)
                  [ -n "$RUN_ID" ] || { echo "❌ No run ID in response"; exit 1; }

                  echo "✅ Created run: $RUN_ID"
                  echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT

              - name: Wait for run completion
                shell: bash
                run: |
                  set -euo pipefail
                  RUN_ID="${{ steps.run.outputs.RUN_ID }}"
                  MAX_WAIT=300
                  ELAPSED=0

                  echo "Waiting for run $RUN_ID to complete..."
                  while [ $ELAPSED -lt $MAX_WAIT ]; do
                    curl -sS \
                      https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/runs/$RUN_ID \
                      -H "Authorization: Bearer $OPENAI_API_KEY" \
                      -H "OpenAI-Beta: assistants=v2" > /tmp/run_status.json

                    STATUS=$(jq -r '.status // empty' /tmp/run_status.json)
                    echo "Run status: $STATUS"

                    case "$STATUS" in
                      completed) echo "✅ Run completed successfully"; break ;;
                      failed|cancelled|expired)
                        echo "❌ Run failed with status: $STATUS"
                        cat /tmp/run_status.json
                        exit 1 ;;
                    esac

                    sleep 3
                    ELAPSED=$((ELAPSED + 3))
                  done

                  [ $ELAPSED -lt $MAX_WAIT ] || { echo "❌ Run timed out after ${MAX_WAIT}s"; exit 1; }

              - name: Get assistant response
                id: response
                shell: bash
                run: |
                  set -euo pipefail

                  echo "Fetching assistant's response..."
                  curl -sS \
                    "https://api.openai.com/v1/threads/$OPENAI_THREAD_ID/messages?order=desc&limit=5" \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    -H "OpenAI-Beta: assistants=v2" > /tmp/messages.json

                  echo "Messages response:"; jq '.' /tmp/messages.json || true

                  ASSISTANT_MSG=$(jq -r '.data[] | select(.role=="assistant") | .content[0].text.value // empty' /tmp/messages.json | head -n 1)
                  [ -n "$ASSISTANT_MSG" ] || ASSISTANT_MSG="(no response)"

                  {
                    echo "RESPONSE<<EOF"
                    echo "$ASSISTANT_MSG"
                    echo "EOF"
                  } >> $GITHUB_OUTPUT

                  echo "Assistant response:"
                  echo "$ASSISTANT_MSG"

              - name: Summary
                run: |
                  echo "OpenAI post complete."
                  echo "Message id: ${{ steps.post.outputs.MSG_ID }}"
                  echo "Run id: ${{ steps.run.outputs.RUN_ID }}"
                  echo ""
                  echo "Assistant response:"
                  echo "${{ steps.response.outputs.RESPONSE }}"
